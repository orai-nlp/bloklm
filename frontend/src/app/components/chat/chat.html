<!-- Confirmation Modal -->
<div 
  class="modal-overlay" 
  [class.active]="showConfirmationModal"
  (click)="$event.target === $event.currentTarget && hideConfirmModal()">
    <div class="modal">
        <div class="modal-title">{{ this.i18n.translate('chat_clear_title') }}</div>
        <div class="modal-content">
            {{ this.i18n.translate('chat_clear_confirmation') }}
        </div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" (click)="hideConfirmModal()">{{ this.i18n.translate('cancel') }}</button>
            <button class="modal-btn modal-btn-confirm" (click)="clearAllData()">{{ this.i18n.translate('chat_clear_button') }}</button>
        </div>
    </div>
</div>

<div class="app-container">
    <div class="main">
        <!-- Messages Container - Scrollable -->
        <div class="chat-container" #chatContainer>
            <div class="loading-spinner" *ngIf="isLoading">
                <span>{{ this.i18n.translate('chat_loading_message') }}...</span>
            </div>
            
            <!-- Messages -->
            <div *ngFor="let message of getDisplayMessages()"
                 class="message-wrapper"
                 [class.user-wrapper]="message.role === 'user'">
                
                <div class="message"
                    [class.user-message]="message.role === 'user'"
                    [class.ai-message]="message.role === 'assistant'">
                
                    <div class="avatar"
                        [class.user-avatar]="message.role === 'user'"
                        [class.ai-avatar]="message.role === 'assistant'">
                        <!-- User icon -->
                        <svg *ngIf="message.role === 'user'" stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="24" width="24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <!-- AI icon -->
                        <svg *ngIf="message.role === 'assistant'" xmlns="http://www.w3.org/2000/svg" 
                            fill="none" viewBox="0 0 24 24" stroke="currentColor" 
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
                            height="28" width="28">
                            <path d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-6.364l-1.414 1.414M7.05 16.95l-1.414 1.414m0-12.728l1.414 1.414M18.364 18.364l-1.414-1.414"/>
                            <path d="M12 8a4 4 0 100 8 4 4 0 000-8z"/>
                        </svg>

                    </div>
                    
                    <!-- Regular message content -->
                    <div *ngIf="!message.isVirtual" class="message-content markdown" [innerHTML]="formatMarkdown(message.content)">
                    </div>
                    
                    <!-- Notebook summary content -->
                    <div *ngIf="message.isVirtual && message.content === 'summary'" class="message-content notebook-summary-content">
                        <div class="summary-icon">âš¡</div>
                        <h2 class="summary-title">{{ notebookService.getCurrentNotebook()?.description }}</h2>
                        <p class="summary-meta">{{ notebookService.getSources()?.length }}  {{i18n.translate('source')}}{{ notebookService.getSources()?.length !== 1 && i18n.language == 'es' ? 's':''}}</p>
                        <div class="summary-text">
                            <p>{{ notebookService.getCurrentNotebook()?.summary }}</p>
                        </div>
                        <!-- <div class="summary-actions">
                            <button class="action-btn copy-btn">
                                <span class="material-icons">content_copy</span>
                            </button>
                        </div> -->
                    </div>
                </div>
            </div><!-- /.message-wrapper -->
        </div>

        <!-- Input Area - Fixed at Bottom -->
        <div class="input-area">
            <div class="input-container">
                <button
                    class="clear-storage-btn"
                    (click)="showConfirmModal()"
                    title="Clear Chat">
                    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="16" width="16" xmlns="http://www.w3.org/2000/svg">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2 2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </button>
                <textarea 
                  #userInput
                  [(ngModel)]="userInputValue"
                  (input)="onInputChange()"
                  (keydown)="onKeyDown($event)"
                  [placeholder]="placeholder_input" 
                  rows="1">
                </textarea>
                <button 
                  class="send-button" 
                  [disabled]="!canSend"
                  (click)="sendMessage()">
                    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="20" width="20" xmlns="http://www.w3.org/2000/svg">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>